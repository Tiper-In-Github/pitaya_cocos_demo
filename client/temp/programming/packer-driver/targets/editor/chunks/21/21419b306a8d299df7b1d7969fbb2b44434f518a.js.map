{"version":3,"sources":["file:///Users/even/workspace/github/pitaya_cocos_demo/client/assets/scripts/net/pitaya/Pitaya.ts"],"names":["Pitaya","Pomelo","starx","window","protocol","Protocol","Init","host","port","url","ws","WebSocket","binaryType","onclose","ev","console","log","onerror","onmessage","onMessage","onopen","sendHandShake","handshakeBuffer","type","version","rsa","handshakePkg","strencode","JSON","stringify","pkg","Package","encode","TYPE_HANDSHAKE","send","buffer","msgs","decode","data","Array","isArray","i","length","msg","dispatch","parse","strdecode","body","code","obj","TYPE_HANDSHAKE_ACK","OnConnectSuccess","TYPE_HEARTBEAT","heartbeat","TYPE_DATA","onData","TYPE_KICK","onKick","Call","route","CallAuth","request","cb","reqId","error","sendMessage","callbacks","set","routeMap","Message","TYPE_REQUEST","TYPE_NOTIFY","packet","Map"],"mappings":";;;sCAQaA,M;;;;;;;;;;;;;;AANJC,MAAAA,M,iBAAAA,M;;;;;;;AAEHC,MAAAA,K,GAASC,MAAD,CAAgBD,K;AACxBE,MAAAA,Q,GAAYD,MAAD,CAAgBE,Q;;wBAGpBL,M,GAAN,MAAMA,MAAN,CAAa;AAEhB;AAEA;AAEA;AAEA;AAEA;AAGA;AACkB,eAAJM,IAAI,CAACC,IAAD,EAAeC,IAAf,EAA6B;AAC3C,cAAIC,GAAG,GAAI,QAAOF,IAAK,IAAGC,IAAK,EAA/B;AACA,eAAKE,EAAL,GAAU,IAAIC,SAAJ,CAAcF,GAAd,CAAV;AACA,eAAKC,EAAL,CAAQE,UAAR,GAAqB,aAArB;;AACA,eAAKF,EAAL,CAAQG,OAAR,GAAmBC,EAAD,IAAa;AAAEC,YAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ,EAA+BF,EAA/B;AAAoC,WAArE;;AACA,eAAKJ,EAAL,CAAQO,OAAR,GAAmBH,EAAD,IAAa;AAAEC,YAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6BF,EAA7B;AAAkC,WAAnE;;AACA,eAAKJ,EAAL,CAAQQ,SAAR,GAAqBJ,EAAD,IAAa;AAAE,iBAAKK,SAAL,CAAeL,EAAf;AAAoB,WAAvD;;AACA,eAAKJ,EAAL,CAAQU,MAAR,GAAkBN,EAAD,IAAa;AAC1B,iBAAKO,aAAL;AACH,WAFD;AAGH,SAxBe,CA0BhB;;;AACkC,qBAAbA,aAAa,GAAG;AACjC,cAAIC,eAAe,GAAG;AAClB,mBAAO;AACHC,cAAAA,IAAI,EAAE,cADH;AAEHC,cAAAA,OAAO,EAAE,OAFN;AAGHC,cAAAA,GAAG,EAAE;AAHF,aADW;AAMlB,oBAAQ;AANU,WAAtB;AAQA,cAAIC,YAAY,GAAGtB,QAAQ,CAACuB,SAAT,CAAmBC,IAAI,CAACC,SAAL,CAAeP,eAAf,CAAnB,CAAnB;AACA,cAAIQ,GAAG,GAAG1B,QAAQ,CAAC2B,OAAT,CAAiBC,MAAjB,CAAwB5B,QAAQ,CAAC2B,OAAT,CAAiBE,cAAzC,EAAyDP,YAAzD,CAAV;AACA,eAAKhB,EAAL,CAAQwB,IAAR,CAAaJ,GAAG,CAACK,MAAjB;AACH,SAvCe,CA0ChB;;;AACwB,eAAThB,SAAS,CAACL,EAAD,EAAU;AAC9B,cAAIsB,IAAI,GAAGhC,QAAQ,CAAC2B,OAAT,CAAiBM,MAAjB,CAAwBvB,EAAE,CAACwB,IAA3B,CAAX;;AACA,cAAIC,KAAK,CAACC,OAAN,CAAcJ,IAAd,CAAJ,EAAyB;AACrB,iBAAK,IAAIK,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,IAAI,CAACM,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;AAClC,kBAAIE,GAAG,GAAGP,IAAI,CAACK,CAAD,CAAd;AACA,mBAAKG,QAAL,CAAcD,GAAd;AACH;AACJ,WALD,MAKO;AACH,iBAAKC,QAAL,CAAcR,IAAd;AACH;AACJ;AAED;AACJ;AACA;AACA;AACA;;;AAC2B,eAARQ,QAAQ,CAACD,GAAD,EAA2C;AAC9D,kBAAQA,GAAG,CAACpB,IAAZ;AACI,iBAAK;AAAA;AAAA,kCAAOQ,OAAP,CAAeE,cAApB;AACI;AACI,oBAAIK,IAAI,GAAGV,IAAI,CAACiB,KAAL,CAAWzC,QAAQ,CAAC0C,SAAT,CAAmBH,GAAG,CAACI,IAAvB,CAAX,CAAX;AACAhC,gBAAAA,OAAO,CAACC,GAAR,CAAY,qBAAZ,EAAmCsB,IAAI,CAACU,IAAxC;;AAEA,oBAAIV,IAAI,CAACU,IAAL,KAAc,GAAlB,EAAuB;AACnB;AACH;;AACD,oBAAIV,IAAI,CAACU,IAAL,KAAc,GAAlB,EAAuB;AACnB;AACH,iBATL,CAUI;;;AACA,oBAAIC,GAAG,GAAG7C,QAAQ,CAAC2B,OAAT,CAAiBC,MAAjB,CAAwB5B,QAAQ,CAAC2B,OAAT,CAAiBmB,kBAAzC,CAAV;AACA,qBAAKxC,EAAL,CAAQwB,IAAR,CAAae,GAAG,CAACd,MAAjB;;AAEA,oBAAI,KAAKgB,gBAAT,EAA2B;AACvB,uBAAKA,gBAAL;AACA,uBAAKA,gBAAL,GAAwB,IAAxB;AACH;AACJ;AACD;;AACJ,iBAAK;AAAA;AAAA,kCAAOpB,OAAP,CAAeqB,cAApB;AACI,mBAAKC,SAAL,CAAeV,GAAG,CAACI,IAAnB;AACA;;AACJ,iBAAK;AAAA;AAAA,kCAAOhB,OAAP,CAAeuB,SAApB;AACI,mBAAKC,MAAL,CAAYZ,GAAG,CAACI,IAAhB;AACA;;AACJ,iBAAK;AAAA;AAAA,kCAAOhB,OAAP,CAAeyB,SAApB;AACI,mBAAKC,MAAL,CAAYd,GAAG,CAACI,IAAhB;AACA;AA9BR;AAgCH;;AAGuB,eAATM,SAAS,CAACf,IAAD,EAAqB,CAG5C;;AAEoB,eAANmB,MAAM,CAACnB,IAAD,EAAqB,CAGzC;;AAEoB,eAANiB,MAAM,CAACjB,IAAD,EAAoB,CAExC;;AAGiB,eAAJoB,IAAI,CAACC,KAAD,EAAgBrB,IAAhB,EAA2B,CAE5C;;AAEqB,eAARsB,QAAQ,GAAG,CAExB;;AAEoB,eAAPC,OAAO,CAACF,KAAD,EAAgBhB,GAAhB,EAA0BmB,EAA1B,EAAwC;AACzD,cAAI,CAACH,KAAL,EAAY;AACR;AACH;;AACD,eAAKI,KAAL;AACAhD,UAAAA,OAAO,CAACiD,KAAR,CAAc,cAAd,EAA8B,KAAKD,KAAnC;AACA,eAAKE,WAAL,CAAiB,KAAKF,KAAtB,EAA6BJ,KAA7B,EAAoChB,GAApC;AACA,eAAKuB,SAAL,CAAeC,GAAf,CAAmB,KAAKJ,KAAxB,EAA+BD,EAA/B;AACA,eAAKM,QAAL,CAAcD,GAAd,CAAkB,KAAKJ,KAAvB,EAA8BJ,KAA9B;AACH;;AAEyB,eAAXM,WAAW,CAACF,KAAD,EAAgBJ,KAAhB,EAA+BrB,IAA/B,EAA0C;AAChE,cAAIf,IAAI,GAAGwC,KAAK,GAAG3D,QAAQ,CAACiE,OAAT,CAAiBC,YAApB,GAAmClE,QAAQ,CAACiE,OAAT,CAAiBE,WAApE;AACA,cAAI5B,GAAG,GAAGvC,QAAQ,CAACiE,OAAT,CAAiBrC,MAAjB,CAAwB+B,KAAxB,EAA+BxC,IAA/B,EAAqC,CAArC,EAAwCoC,KAAxC,EAA+CrB,IAA/C,CAAV;AACA,cAAIkC,MAAM,GAAGpE,QAAQ,CAAC2B,OAAT,CAAiBC,MAAjB,CAAwB5B,QAAQ,CAAC2B,OAAT,CAAiBuB,SAAzC,EAAoDX,GAApD,CAAb;AACA,eAAKjC,EAAL,CAAQwB,IAAR,CAAasC,MAAM,CAACrC,MAApB;AACH;;AAvIe,O;;AAAPnC,MAAAA,M,CAGMU,E;AAHNV,MAAAA,M,CAKMkE,S,GAAY,IAAIO,GAAJ,E;AALlBzE,MAAAA,M,CAOMoE,Q,GAAW,IAAIK,GAAJ,E;AAPjBzE,MAAAA,M,CASM+D,K,GAAgB,C;AATtB/D,MAAAA,M,CAWKmD,gB,GAAoC,I","sourcesContent":["import proto from \"../../../../proto_js/proto.js\";\nimport { Session } from \"../../logic/login/LoginModel\";\nimport { Pomelo } from \"./Pomelo\";\n\nconst starx = (window as any).starx\nconst protocol = (window as any).Protocol\n\n\nexport class Pitaya {\n\n    //websocket\n    private static ws: WebSocket;\n    //回调map\n    private static callbacks = new Map<number, Function>();\n    //路由map\n    private static routeMap = new Map<number, string>();\n    //请求的id,每次请求自增1\n    private static reqId: number = 0\n    //整个pitaya连接成功后的回调\n    public static OnConnectSuccess: Function | null = null;\n\n    //step1:初始化\n    public static Init(host: string, port: number) {\n        let url = `ws://${host}:${port}`\n        this.ws = new WebSocket(url);\n        this.ws.binaryType = 'arraybuffer';\n        this.ws.onclose = (ev: any) => { console.log(\"websocket close\", ev) };\n        this.ws.onerror = (ev: any) => { console.log(\"websocket err\", ev) };\n        this.ws.onmessage = (ev: any) => { this.onMessage(ev) };\n        this.ws.onopen = (ev: any) => {\n            this.sendHandShake()\n        };\n    }\n\n    //step2:发送handshake\n    private static async sendHandShake() {\n        let handshakeBuffer = {\n            'sys': {\n                type: \"pitaya_cocos\",\n                version: \"1.0.0\",\n                rsa: {}\n            },\n            'user': {}\n        };\n        let handshakePkg = protocol.strencode(JSON.stringify(handshakeBuffer))\n        let pkg = protocol.Package.encode(protocol.Package.TYPE_HANDSHAKE, handshakePkg);\n        this.ws.send(pkg.buffer);\n    }\n\n\n    //step3:收到消息\n    private static onMessage(ev: any) {\n        let msgs = protocol.Package.decode(ev.data);\n        if (Array.isArray(msgs)) {\n            for (let i = 0; i < msgs.length; i++) {\n                let msg = msgs[i];\n                this.dispatch(msg)\n            }\n        } else {\n            this.dispatch(msgs)\n        }\n    }\n\n    /**\n     * 消息分发器\n     * @param msg 收到的服务器消息\n     * @returns \n     */\n    private static dispatch(msg: { type: number, body?: Uint8Array }) {\n        switch (msg.type) {\n            case Pomelo.Package.TYPE_HANDSHAKE:\n                {\n                    let data = JSON.parse(protocol.strdecode(msg.body));\n                    console.log(\" handshake msg.code\", data.code)\n\n                    if (data.code === 501) {\n                        return;\n                    }\n                    if (data.code !== 200) {\n                        return;\n                    }\n                    //step4: handshake回应，不然服务器会断开\n                    let obj = protocol.Package.encode(protocol.Package.TYPE_HANDSHAKE_ACK);\n                    this.ws.send(obj.buffer);\n\n                    if (this.OnConnectSuccess) {\n                        this.OnConnectSuccess()\n                        this.OnConnectSuccess = null\n                    }\n                }\n                break\n            case Pomelo.Package.TYPE_HEARTBEAT:\n                this.heartbeat(msg.body)\n                break\n            case Pomelo.Package.TYPE_DATA:\n                this.onData(msg.body as ArrayBuffer)\n                break\n            case Pomelo.Package.TYPE_KICK:\n                this.onKick(msg.body)\n                break\n        }\n    }\n\n\n    private static heartbeat(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onKick(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onData(data: ArrayBuffer) {\n\n    }\n\n\n    public static Call(route: string, data: any) {\n\n    }\n\n    public static CallAuth() {\n\n    }\n\n    public static request(route: string, msg: any, cb: Function) {\n        if (!route) {\n            return;\n        }\n        this.reqId++;\n        console.error(\"pitaya reqid\", this.reqId);\n        this.sendMessage(this.reqId, route, msg);\n        this.callbacks.set(this.reqId, cb);\n        this.routeMap.set(this.reqId, route);\n    };\n\n    private static sendMessage(reqId: number, route: string, data: any) {\n        let type = reqId ? protocol.Message.TYPE_REQUEST : protocol.Message.TYPE_NOTIFY;\n        let msg = protocol.Message.encode(reqId, type, 0, route, data);\n        let packet = protocol.Package.encode(protocol.Package.TYPE_DATA, msg);\n        this.ws.send(packet.buffer);\n    };\n\n\n\n\n}\n\n"]}