{"version":3,"sources":["file:///Users/even/workspace/github/pitaya_cocos_demo/client/assets/scripts/net/pitaya/Pitaya.ts"],"names":["PitayaWs","proto","Pomelo","starx","window","protocol","Protocol","Init","host","port","handshakeBuffer","type","version","rsa","Promise","reslove","reject","_ws","WebSocket","reqId","binaryType","onclose","ev","console","log","onerror","onmessage","dispatch","msg","Package","TYPE_HANDSHAKE","handshake","body","TYPE_HEARTBEAT","heartbeat","TYPE_DATA","onData","TYPE_KICK","onKick","msgs","decode","data","Array","isArray","i","length","onopen","handshakePkg","strencode","JSON","stringify","pkg","encode","send","buffer","parse","strdecode","code","RES_OLD_CLIENT","RES_OK","Call","route","CallAuth","token","reqByte","lobby","ReqAuth","Token","finish","request","StartXCallAuth","init","error","e","resp","RespAuth","cb","sendMessage","callbacks","set","routeMap","encodeMsg","packet","Message","TYPE_REQUEST","TYPE_NOTIFY","Map","RES_FAIL"],"mappings":"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","sourcesContent":["import proto from \"../../../../proto_js/proto.js\";\nimport { Session } from \"../../logic/login/LoginModel\";\nimport { Pomelo } from \"./Pomelo\";\n\n\nconst starx = (window as any).starx\nconst protocol = (window as any).Protocol\nexport class PitayaWs {\n\n    private static _ws: WebSocket;\n    private static callbacks = new Map<number, Function>();\n    private static routeMap = new Map<number, string>();\n    private static reqId: number\n\n    public static async Init(host: string, port: number) {\n\n        let handshakeBuffer = {\n            'sys': {\n                type: \"pitaya_cocos\",\n                version: \"1.0.0\",\n                rsa: {}\n            },\n            'user': {}\n        };\n\n        return new Promise((reslove, reject) => {\n            this._ws = new WebSocket('ws://localhost:3250');\n            this.reqId = 0;\n            this._ws.binaryType = 'arraybuffer';\n            this._ws.onclose = (ev: Event) => {\n                console.log(\"websocket close\", ev)\n                reject(false)\n            };\n            this._ws.onerror = (ev: Event) => {\n                console.log(\"websocket err\", ev)\n                reject(false)\n            };\n            this._ws.onmessage = (ev: any) => {\n                let dispatch = (msg: { type: number, body?: Uint8Array }) => {\n                    switch (msg.type) {\n                        case Pomelo.Package.TYPE_HANDSHAKE:\n                            this.handshake(msg.body)\n                            break\n                        case Pomelo.Package.TYPE_HEARTBEAT:\n                            this.heartbeat(msg.body)\n                            break\n                        case Pomelo.Package.TYPE_DATA:\n                            this.onData(msg.body as ArrayBuffer)\n                            break\n                        case Pomelo.Package.TYPE_KICK:\n                            this.onKick(msg.body)\n                            break\n                    }\n                }\n                let msgs = protocol.Package.decode(ev.data);\n                console.log(\"websocket onmessage\", msgs)\n                if (Array.isArray(msgs)) {\n                    for (let i = 0; i < msgs.length; i++) {\n                        let msg = msgs[i];\n                        dispatch(msg)\n                    }\n\n                } else {\n                    dispatch(msgs)\n                }\n\n                console.log(\"websocket on message ,reslove\")\n                reslove(true)\n            };\n\n            this._ws.onopen = (ev: Event) => {\n                let handshakePkg = protocol.strencode(JSON.stringify(handshakeBuffer))\n                var pkg = protocol.Package.encode(protocol.Package.TYPE_HANDSHAKE, handshakePkg);\n                this._ws.send(pkg.buffer);\n            };\n\n\n        })\n    }\n\n    private static RES_OK = 200;\n    private static RES_FAIL = 500;\n    private static RES_OLD_CLIENT = 501;\n    private static handshake(data?: ArrayBuffer) {\n        let msg = JSON.parse(protocol.Protocol.strdecode(data));\n        console.log(\" handshake msg.code\")\n        \n        if (msg.code === this.RES_OLD_CLIENT) {\n            // starx.emit('error', 'client version not fullfill');\n            return;\n        }\n\n        if (msg.code !== this.RES_OK) {\n            // starx.emit('error', 'handshake fail');\n            return;\n        }\n\n        // handshakeInit(msg);\n\n        // var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\n        // send(obj);\n        // if (initCallback) {\n        //     initCallback(socket);\n        // }\n    }\n\n    private static heartbeat(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onKick(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onData(data: ArrayBuffer) {\n        // const msg = Pomelo.Message.decode(data);\n        // if (msg.route == \"Connector.Handler.CallAuth\") {\n        //     let resp = proto.lobby.RespAuth.decode(msg.body)\n        //     console.log(\"Connector.Handler.CallAuth, resp=\", resp)\n        // }\n    }\n\n\n    public static Call(route: string, data: any) {\n        // console.log(\" pitaya call\")\n        // this.reqId++;\n        // let msg = protocol.Message.encode(this.reqId, Pomelo.Message.TYPE_REQUEST, 0, route, data);\n        // let pkg = protocol.Package.encode(Pomelo.Package.TYPE_DATA, msg)\n        // // let msg = Pomelo.Message.encode(this._reqId, Pomelo.Message.TYPE_REQUEST, 0, route, data);\n        // // let pkg = Pomelo.Package.encode(Pomelo.Package.TYPE_DATA, msg)\n        // this._ws.send(pkg.buffer);\n        // this.testStartX()\n    }\n\n    public static CallAuth() {\n        let token = \"aa\"\n        console.log(\"startx token \", token)\n        let reqByte = proto.lobby.ReqAuth.encode({ Token: token }).finish()\n        console.log(\" pitaya 1-1 1-1 1-1 reqByte \", reqByte);\n        this.request(\"Connector.Handler.CallAuth\", reqByte, () => { })\n    }\n\n\n    public static StartXCallAuth() {\n        starx.init(\n            {\n                host: \"localhost\",//Session.WsUrl.Host,\n                port: 3250,//Session.WsUrl.Port\n            },\n            () => {\n                let token = \"aa\"\n                console.log(\"startx token \", token)\n                let reqByte = proto.lobby.ReqAuth.encode({ Token: token }).finish();\n                console.error(\"startx 2-1 2-1 2-1 \", reqByte);\n                starx.request(\"Connector.Handler.CallAuth\", reqByte, (e: any) => {\n                    let resp = proto.lobby.RespAuth.decode(e);\n                    console.log(\" Connector.Handler.CallAuth, success resp= \", resp);\n                });\n            })\n    }\n\n\n    private static request(route: string, msg: any, cb: Function) {\n        if (!route) {\n            return;\n        }\n\n        this.reqId++;\n\n        console.error(\"pitaya reqid\", this.reqId);\n\n        this.sendMessage(this.reqId, route, msg);\n        this.callbacks.set(this.reqId, cb);\n        this.routeMap.set(this.reqId, route);\n    };\n\n    private static sendMessage(reqId: number, route: string, msg: any) {\n        var encodeMsg = this.encode(reqId, route, msg);\n        console.log(\" pitaya  1-2 1-2 1-2     msg \", encodeMsg)\n        var packet = protocol.Package.encode(protocol.Package.TYPE_DATA, encodeMsg);\n        console.log(\" pitaya  1-3 1-3 1-3     packet \", packet)\n        this.send(packet);\n    };\n\n    private static send(packet: any) {\n        this._ws.send(packet);\n    };\n\n    private static encode(reqId: number, route: string, msg: any) {\n        var type = reqId ? protocol.Message.TYPE_REQUEST : protocol.Message.TYPE_NOTIFY;\n        return protocol.Message.encode(reqId, type, 0, route, msg);\n    }\n}\n\n"]}