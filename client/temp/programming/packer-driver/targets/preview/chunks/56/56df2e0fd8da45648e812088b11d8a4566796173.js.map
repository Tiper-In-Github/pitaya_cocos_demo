{"version":3,"sources":["file:///Users/even/workspace/github/pitaya_cocos_demo/client/assets/scripts/net/pitaya/Pitaya.ts"],"names":["Pitaya","Pomelo","Init","host","port","Promise","resolve","reject","onConnectSuccess","url","connector","ws","WebSocket","binaryType","onclose","ev","console","log","onerror","onmessage","onMessage","onopen","sendHandShake","handshakeBuffer","type","version","rsa","msg","Protocol","StrEncode","JSON","stringify","pkg","Package","Encode","TYPE_HANDSHAKE","send","buffer","msgs","Decode","data","Array","isArray","i","length","dispatch","parse","StrDecode","body","code","obj","TYPE_HANDSHAKE_ACK","TYPE_HEARTBEAT","heartbeat","TYPE_DATA","onData","TYPE_KICK","onKick","Message","TYPE_RESPONSE","cb","callbacks","get","id","delete","TYPE_PUSH","routeMap","route","Call","reqId","TYPE_REQUEST","packet","set","Notify","TYPE_NOTIFY","Push","func","has","Map"],"mappings":"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","sourcesContent":["import { Pomelo } from \"./Pomelo\";\n\nexport class Pitaya {\n    //websocket\n    private static ws: WebSocket;\n    //回调map\n    private static callbacks = new Map<number, Function>();\n    //路由map\n    private static routeMap = new Map<string, Function>();\n    //请求的id,每次请求自增1\n    private static reqId: number = 0\n    //整个pitaya连接成功后的回调\n    private static onConnectSuccess: Function | null = null;\n\n    //step1:包装成await/async\n    public static async Init(host: string, port: number) {\n        return new Promise((resolve, reject) => {\n            this.onConnectSuccess = () => {\n                resolve(true)\n            }\n            let url = `ws://${host}:${port}`\n            this.connector(url)\n        })\n    }\n\n    //step2:初始化\n    private static connector(url: string) {\n        this.ws = new WebSocket(url);\n        this.ws.binaryType = 'arraybuffer';\n        this.ws.onclose = (ev: any) => { console.log(\"websocket close\", ev) };\n        this.ws.onerror = (ev: any) => { console.log(\"websocket err\", ev) };\n        this.ws.onmessage = (ev: any) => { this.onMessage(ev) };\n        this.ws.onopen = (ev: any) => {\n            this.sendHandShake()\n        };\n    }\n\n    //step3:发送handshake\n    private static async sendHandShake() {\n        let handshakeBuffer = {\n            'sys': {\n                type: \"pitaya_cocos\",\n                version: \"1.0.0\",\n                rsa: {}\n            },\n            'user': {}\n        };\n        let msg = Pomelo.Protocol.StrEncode(JSON.stringify(handshakeBuffer))\n        let pkg = Pomelo.Package.Encode(Pomelo.Package.TYPE_HANDSHAKE, msg);\n        this.ws.send(pkg.buffer);\n    }\n\n\n    //step4:收到消息,分发\n    private static onMessage(ev: any) {\n        let msgs = Pomelo.Package.Decode(ev.data);\n        if (Array.isArray(msgs)) {\n            for (let i = 0; i < msgs.length; i++) {\n                let msg = msgs[i];\n                this.dispatch(msg)\n            }\n        } else {\n            this.dispatch(msgs)\n        }\n    }\n\n    /**\n     * step5, 解析消息分发器\n     * @param msg 收到的服务器消息\n     * @returns \n     */\n    private static dispatch(msg: { type: number, body?: Uint8Array }) {\n        switch (msg.type) {\n            case Pomelo.Package.TYPE_HANDSHAKE:\n                {\n                    let data = JSON.parse(Pomelo.Protocol.StrDecode(msg.body as Uint8Array));\n                    console.log(\" handshake msg.code\", data.code)\n                    if (data.code === 501) {\n                        return;\n                    }\n                    if (data.code !== 200) {\n                        return;\n                    }\n\n                    //step6: handshake回应，不然服务器会断开\n                    let obj = Pomelo.Package.Encode(Pomelo.Package.TYPE_HANDSHAKE_ACK);\n                    this.ws.send(obj.buffer);\n\n                    //step7: 连接成功回调，加到step1的Promise\n                    if (this.onConnectSuccess) {\n                        this.onConnectSuccess()\n                    }\n                }\n                break\n            case Pomelo.Package.TYPE_HEARTBEAT:\n                this.heartbeat(msg.body)\n                break\n            case Pomelo.Package.TYPE_DATA:\n                this.onData(msg.body as ArrayBuffer)\n                break\n            case Pomelo.Package.TYPE_KICK:\n                this.onKick(msg.body)\n                break\n        }\n    }\n\n\n    private static heartbeat(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onKick(data?: ArrayBuffer) {\n\n\n    }\n\n    private static onData(data: ArrayBuffer) {\n        let msg = Pomelo.Message.Decode(data);\n        switch (msg.type) {\n            case Pomelo.Message.TYPE_RESPONSE:\n                {\n                    var cb = this.callbacks.get(msg.id);\n                    this.callbacks.delete(msg.id);\n                    if (cb) {\n                        cb(msg.body);\n                    }\n                }\n                break;\n            case Pomelo.Message.TYPE_PUSH:\n                {\n                    var cb = this.routeMap.get(msg.route as string);\n                    if (cb) {\n                        cb(msg.body);\n                    }\n                }\n                break;\n        }\n    }\n\n    /**\n     * Call方法，即req-resp模式\n     * @param route 路由\n     * @param msg \n     * @returns \n     */\n    public static async Call(route: string, data: any) {\n        if (!route) {\n            return;\n        }\n        return new Promise((resolve, reject) => {\n            this.reqId++;\n            let type = Pomelo.Message.TYPE_REQUEST;\n            let msg = Pomelo.Message.Encode(this.reqId, type, 0, route, data);\n            let packet = Pomelo.Package.Encode(Pomelo.Package.TYPE_DATA, msg);\n            this.ws.send(packet.buffer);\n            this.callbacks.set(this.reqId, (data: any) => {\n                resolve(data);\n            });\n\n        })\n    };\n\n    /**\n     * Notify方法，即notify服务器，不需要收到回复消息\n     * @param route 路由\n     * @param data 发送服务器的数据\n     * @returns \n     */\n    public static Notify(route: string, data: any) {\n        let type = Pomelo.Message.TYPE_NOTIFY;\n        let msg = Pomelo.Message.Encode(this.reqId, type, 0, route, data);\n        let packet = Pomelo.Package.Encode(Pomelo.Package.TYPE_DATA, msg);\n        this.ws.send(packet.buffer);\n    }\n\n    /**\n    * Push方法，监听来自服务器的Push消息\n    * @param route 路由\n    * @param func 监听消息\n    * @returns \n    */\n    public static Push(route: string, func: Function) {\n        if (this.routeMap.has(route)) {\n            return;\n        }\n        this.routeMap.set(route, func);\n    }\n}\n\n"]}